$(function() {
  var rover = RVR.rover({});
      container = RVR.container({});
      grid = RVR.grid({
        parent: container.getElement(),
        dimensions: container.getLevelDimensions()
      }),
      goal = {x: grid.getColumnCount() - 1, y: grid.getRowCount() - 1},

      roverOffsetX = function(d) {
        return x(d.x) - (cellWidth / 4);
      },
      roverOffsetY = function(d) {
        return y(d.y) - (cellHeight / 4);
      },
      goalReached = false,

      transitionDuration = 300,
      animatedRender = function() {
        d3.transition()
          .duration(750)
          .each(render);
      },

      render = function() {
        grid.render();

        var roverSelection = container.getElement().selectAll(".rover").data([rover.getPosition()]);
        var roverEnter = roverSelection.enter()
          .append("rect")
          .attr("class", "rover")
          .attr("x", grid.offsetX(.25))
          .attr("y", roverOffsetY)
          .attr("width", cellWidth / 2)
          .attr("height", cellHeight / 2);

        var goalSelection = container.getElement().selectAll(".goal").data([goal]);
        goalSelection.enter()
          .append("circle")
          .attr("class", "goal")
          .attr("r", cellWidth / 4)
          .attr("cx", function(d) { return x(d.x); })
          .attr("cy", function(d) { return y(d.y); });
      },

      reachedGoal = function() {
        var position = rover.getPosition();
        if (position.x === goal.x && position.y === goal.y) return true;
        return false;
      },

      endLevel = function() {
        goalReached = true;
        $("#goal-reached").modal('show');
      },

      moveRover = function(coordinate, direction) {
        if (reachedGoal()) {
          endLevel();
        }

        if (!rover.isMoving()) return;

        var nextPosition = rover.nextPosition();
        if (grid.outOfBounds(nextPosition) || grid.collision(nextPosition)) return;

        rover.updatePosition();

        svg.selectAll(".rover").transition()
          .duration(transitionDuration)
          .ease('linear')
          .attr("transform", "translate(" + x(rover.getPosition().x) + "," + y(rover.getPosition().y) + ")");
      },

      updateScene = function() {
        moveRover();
        if (!goalReached) {
          setTimeout(function() { updateScene(); }, transitionDuration);
        }
      },

      generate = function() {
        rover.reset();
        grid.reset();
        animatedRender();
      };

    $("#generate").click(function() {
      generate();
    });

    $(".move").click(function() {
      var action = $(this).attr("data-action");
      if (action.indexOf("on") > -1) {
        rover.cruise(true);
      } else {
        rover.cruise(false);
      }
    });

    $(".rotate").click(function() {
      rover.rotate(-90);
    });

    generate();

    setTimeout(function() { updateScene() }, transitionDuration);
});
