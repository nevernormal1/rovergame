$(function() {
  var container = RVR.container({}),
      grid = RVR.grid({
        parent: container.getElement(),
        dimensions: container.getLevelDimensions()
      }),

      rover = RVR.rover({
        parent: container.getElement(),
        grid: grid
      }),

      goal = RVR.goal({
        parent: container.getElement(),
        grid: grid,
        x: grid.getColumnCount() - 1,
        y: grid.getRowCount() - 1
      }),

      animatedRender = function() {
        d3.transition()
          .duration(750)
          .each(render);
      },

      render = function() {
        grid.render();
        rover.render();
        goal.render();
      },

      updateScene = function() {
        rover.updatePosition();

        if (!goal.reached(rover.getPosition())) {
          setTimeout(updateScene, RVR.transitionDuration);
        } else {
          $("#goal-reached").modal('show');
        }
      },

      generate = function() {
        rover.reset();
        grid.reset();
        animatedRender();
      };

    $("#generate").click(function() {
      generate();
    });

    $(".move").click(function() {
      var action = $(this).attr("data-action");
      if (action.indexOf("on") > -1) {
        rover.setCruise(true);
      } else {
        rover.setCruise(false);
      }
    });

    $(".rotate").click(function() {
      rover.rotate(-90);
    });

    generate();

    setTimeout(function() { updateScene() }, RVR.transitionDuration);
});
