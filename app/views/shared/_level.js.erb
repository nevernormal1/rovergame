$(function() {
  var container = RVR.container({}),
      grid = RVR.grid({
        parent: container.getElement(),
        dimensions: container.getLevelDimensions()
      }),

      rover = RVR.rover({
        parent: container.getElement(),
        grid: grid
      }),

      goal = RVR.goal({
        parent: container.getElement(),
        grid: grid,
        x: grid.getColumnCount() - 1,
        y: grid.getRowCount() - 1
      }),

      animatedRender = function() {
        d3.transition()
          .duration(750)
          .each(render);
      },

      render = function() {
        grid.render();
        rover.render();
        goal.render();
      },

      timeout,

      updateScene = function() {
        rover.updatePosition();
        rover.render();

        if (!goal.reached(rover.getPosition())) {
          timeout = setTimeout(updateScene, RVR.transitionDuration);
        } else {
          $("#goal-reached").modal('show');
        }
      },

      generate = function() {
        rover.reset();
        grid.reset();
        animatedRender();
      },

      topLevelInstructions = RVR.instructionGroups.get(),

      addBlock = function(instruction, element, placeholder) {
        var block = $("<div/>", {class: "well block"}),
            linkWrapper = $("<p/>", {class: "add-instruction"});

        if (placeholder) {
          $("<div/>", {class: "placeholder"}).append($("<p/>").text("Otherwise")).insertAfter(element.closest(".instruction-container"));
        }

        block.insertAfter(element.closest(".instruction-container"));

        linkWrapper.appendTo(block);

        $("<a/>", {href: "#", text: "Add Instruction"}).appendTo(linkWrapper);

        addInstructionRow(linkWrapper);

        return block;
      },

      removeBlock = function(instruction, element) {
        var nextRow = element.closest(".instruction-container").next();
        if (nextRow.hasClass("block")) {
          nextRow.remove();
        }
        nextRow = element.closest(".instruction-container").next();
        if (nextRow.hasClass("placeholder")) {
          nextRow.next().remove();
          nextRow.remove();
        }
      },

      addInstructionRow = function(addLink) {
        addInstructionSelect(
          $("<div/>", {class: "instruction-container"}).insertBefore(addLink)
        );
      },

      renderInstruction = function(instruction, container) {
        var input = container.find("input.instruction"),
            showInstructions = $('<i class="icon-circle-arrow-down pull-right show-instructions"></i>'),
            select2Container = container.find(".select2-container"),
            instructionText,
            argSelect,
            block;

        select2Container.hide();

        if (instruction.args && instruction.args.length > 0) {
          instructionText = $('<p/>');

          instruction.args.forEach(function(argParams) {
            argSelect = $("<select/>", {name: argParams.name, class: "arguments"});
            argParams.values.forEach(function(argValue) {
              argSelect.append($('<option/>', {value: argValue, text: argValue}));
            });

            instructionText.append(
              $('<span/>', {text: argParams.label}).append(argSelect)
            )
          });
        } else {
          instructionText = $('<p/>', {text: instruction.selectLabel || instruction.label});
        }

        if (instruction.block) {
          container.addClass('block-container');
        }

        showInstructions.click(function() {
          showInstructions.closest(".instruction-content").hide();
          select2Container.show();
          input.select2("open");
        });

        container.append(
          $('<div/>', {class: 'instruction-content'})
            .append(showInstructions)
            .append(instructionText)
        );

        removeBlock(instruction, input);

        if (typeof instruction.block !== "undefined") {
          block = addBlock(instruction, input);
          if (instruction.value === "if") {
            addBlock(instruction, input, "Otherwise");
            block.addClass("secondary");
          }
        }
      },

      formatInstructionSelect = function(data, container) {
        renderInstruction(data.instruction, container.closest(".instruction-container"));

        return data.instruction.label; 
      },

      formatInstructionResult = function(data) {
        if (!data.id) return data.text;

        return data.instruction.label; 
      },

      addInstructionSelect = function(parent) {
        var input = $("<input/>", {type: "hidden", class: "instruction", style: "width:100%"}).appendTo(parent),
            data = [],
            children;

        topLevelInstructions.forEach(function(instructionGroup) {
          children = [];

          instructionGroup.instructions.forEach(function(instruction) {
            children.push({id: instruction.value, instruction: instruction});
          });

          data.push({text: instructionGroup.label, children: children});
        });

        input.select2({
          placeholder: "Choose an instruction",
          data: data,
          formatResult: formatInstructionResult,
          formatSelection: formatInstructionSelect
        });
      },

      prepareInstruction = function(instructionElement) {
        var data, instruction, instance, container;

        data = instructionElement.select2("data");
        if (data == null) {
          return;
        }
        instruction = data.instruction;
        instance = instruction.instance();
        container = instructionElement.closest(".instruction-container");

        container.find("select.arguments").each(function() {
          instance.arg($(this).attr("name"), $(this).val());
        });

        if (instruction.block) {
          container.next().children().not(".block").find("input.instruction").each(function() {
            instance.subInstruction(prepareInstruction($(this)));
          });
        }

        if (instruction.value === "if") {
          container.next().next().next().children().not(".block").find("input.instruction").each(function() {
            instance.elseInstruction(prepareInstruction($(this)));
          });
        }

        return instance;
      },

      initializeProgramPanel = function() {
        $("#program-panel").empty()
          .append($("<p/>", {class: "add-instruction"})
            .append($("<a/>", {href: "#"}).text("Add Instruction")))

        addInstructionRow($(".add-instruction"));
        generate();
      },

      stop = function() {
        if (typeof timeout !== "undefined" && timeout != null) {
          clearTimeout(timeout);
          timeout = null;
        }
      },

      runProgram = function() {
        $("#status").removeClass("label-warning").addClass("label-success").text("Running");
        $("#stop-program").text("Stop");
        $("#program-panel > div.instruction-container").each(function() {
          prepareInstruction($(this).find("input.instruction")).callback();
        });
        timeout = setTimeout(updateScene, RVR.transitionDuration);
      };

    $("#generate").click(function() {
      generate();
    });

    $("#run-program").click(function() {
      stop();
      runProgram();
    });

    $("#pause-program").click(function() {
      $("#status").text("Paused").removeClass("label-success").addClass("label-warning");
      stop();
    });

    $("#stop-program").click(function() {
      $("#status").text("Stopped").removeClass("label-success").removeClass("label-warning");
      stop();
      generate();
      $("#stop-program").text("Generate");
    });

    $(document).on("click", ".add-instruction a", function() {
      addInstructionRow($(this).closest(".add-instruction"));
      return false;
    });

    initializeProgramPanel();
});

